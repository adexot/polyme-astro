---
import type { Activity } from "../types/polymarket";
import { BarChart } from "../components/react/BarChart";
import { BrushBarChart } from "../components/react/BrushBarChart";
import { HighlightZoomLineChart } from "../components/react/HighlightZoomLineChart";

export interface Props {
    activityData: Activity[] | null;
}

const { activityData } = Astro.props;

// Helper function to get the bucket info for a timestamp (12pm Day1 to 12pm Day2)
function getBucketInfo(timestamp: number): { key: string; startDate: Date } {
    const date = new Date(timestamp * 1000);
    const hour = date.getUTCHours();
    
    // If before 12pm (noon), it belongs to previous day's bucket
    // If 12pm or after, it belongs to current day's bucket
    let bucketDate = new Date(date);
    if (hour < 12) {
        bucketDate.setUTCDate(bucketDate.getUTCDate() - 1);
    }
    
    // Set to start of day (midnight) for consistent bucket start
    bucketDate.setUTCHours(0, 0, 0, 0);
    
    const day1 = new Date(bucketDate);
    const day2 = new Date(day1);
    day2.setUTCDate(day2.getUTCDate() + 1);
    
    // Format dates as "MMM DD, YYYY"
    const formatDate = (d: Date) => {
        return d.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            timeZone: 'UTC'
        });
    };
    
    return {
        key: `${formatDate(day1)} - ${formatDate(day2)}`,
        startDate: day1
    };
}

// Helper function to calculate metrics for a group of activities
function calculateBucketMetrics(activities: Activity[]) {
    const buyActivities = activities.filter(
        (a) => a.side === "BUY" || a.type === "TRADE"
    );
    const redeemActivities = activities.filter((a) => a.type === "REDEEM");
    
    const buyTotal = buyActivities.reduce(
        (sum, a) => sum + (a.usdcSize || 0),
        0
    );
    const redeemTotal = redeemActivities.reduce(
        (sum, a) => sum + (a.usdcSize || 0),
        0
    );
    
    return {
        buyCount: buyActivities.length,
        buyTotal: Number(buyTotal.toFixed(2)),
        redeemCount: redeemActivities.length,
        redeemTotal: Number(redeemTotal.toFixed(2)),
        difference: Number((redeemTotal - buyTotal).toFixed(2)),
    };
}

// Group activities into buckets
interface BucketData {
    key: string;
    startDate: Date;
    activities: Activity[];
}

const buckets = new Map<string, BucketData>();

if (activityData && activityData.length > 0) {
    activityData.forEach((activity) => {
        const bucketInfo = getBucketInfo(activity.timestamp);
        if (!buckets.has(bucketInfo.key)) {
            buckets.set(bucketInfo.key, {
                key: bucketInfo.key,
                startDate: bucketInfo.startDate,
                activities: []
            });
        }
        buckets.get(bucketInfo.key)!.activities.push(activity);
    });
}

// Convert to array and sort by date (most recent first for display)
const bucketEntries = Array.from(buckets.values()).sort((a, b) => {
    return b.startDate.getTime() - a.startDate.getTime();
});

// Prepare chart data (sorted chronologically, oldest first for chart)
const chartData = bucketEntries
    .map((bucket) => {
        const metrics = calculateBucketMetrics(bucket.activities);
        return {
            name: bucket.key,
            difference: metrics.difference,
        };
    })
    .reverse(); // Reverse to show oldest to newest
---

{activityData && activityData.length > 0 && bucketEntries.length > 0 ? (
    <div class="space-y-6">
        {/* Chart Type Selector */}
        {chartData.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4">
                <label class="text-sm text-[var(--color-ash)] mr-2 self-center">Chart Type:</label>
                <button
                    id="chart-type-bar"
                    class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-[var(--color-cyan)] text-[var(--color-slate)] hover:opacity-90 chart-button-active"
                    data-chart-type="bar"
                >
                    Bar Chart
                </button>
                <button
                    id="chart-type-brush"
                    class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-[var(--color-mist)] text-[var(--color-bone)] hover:bg-[var(--color-ash)]"
                    data-chart-type="brush"
                >
                    Brush Bar Chart
                </button>
                <button
                    id="chart-type-line"
                    class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-[var(--color-mist)] text-[var(--color-bone)] hover:bg-[var(--color-ash)]"
                    data-chart-type="line"
                >
                    Highlight & Zoom Line
                </button>
            </div>
        )}

        {/* Chart Container */}
        {chartData.length > 0 && (
            <div id="bar-chart-container">
                <div id="chart-bar" class="chart-view chart-active">
                    <BarChart
                        client:load
                        data={chartData}
                        title="Activity Difference Over Time"
                        height={400}
                        showLegend={false}
                        showGrid={true}
                    />
                </div>
                <div id="chart-brush" class="chart-view" style="display: none;">
                    <BrushBarChart
                        client:load
                        data={chartData}
                        title="Activity Difference Over Time"
                        height={400}
                        showLegend={false}
                        showGrid={true}
                    />
                </div>
                <div id="chart-line" class="chart-view" style="display: none;">
                    <HighlightZoomLineChart
                        client:load
                        data={chartData}
                        title="Activity Difference Over Time"
                        height={400}
                        showLegend={false}
                        showGrid={true}
                    />
                </div>
            </div>
        )}

        {/* Activity Cards Grid */}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
            {bucketEntries.map((bucket) => {
                const metrics = calculateBucketMetrics(bucket.activities);
                return (
                    <div class="bg-[var(--color-slate)] border border-[var(--color-mist)] rounded-lg p-4">
                        <div class="text-sm font-semibold text-[var(--color-cyan)] mb-2 border-b border-[var(--color-mist)]">
                            {bucket.key}
                        </div>
                        
                        <div class="space-y-1">
                            {/* BUY Metrics */}
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-[var(--color-ash)] uppercase tracking-wider">
                                    BUY
                                </span>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-[var(--color-bone)]">
                                        {metrics.buyCount} trades
                                    </div>
                                    <div class="text-sm text-[var(--color-coral)]">
                                        ${metrics.buyTotal.toLocaleString()}
                                    </div>
                                </div>
                            </div>
                            
                            {/* REDEEM Metrics */}
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-[var(--color-ash)] uppercase tracking-wider">
                                    REDEEM
                                </span>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-[var(--color-bone)]">
                                        {metrics.redeemCount} trades
                                    </div>
                                    <div class="text-sm text-[var(--color-cyan)]">
                                        ${metrics.redeemTotal.toLocaleString()}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Difference */}
                            <div class="flex justify-between items-center pt-2 border-t border-[var(--color-mist)]">
                                <span class="text-sm text-[var(--color-ash)] uppercase tracking-wider">
                                    Difference
                                </span>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-[var(--color-bone)]">
                                        {metrics.buyCount - metrics.redeemCount}
                                    </div>
                                    <div
                                        class={`text-sm font-semibold ${
                                            metrics.difference >= 0
                                                ? "text-green-400"
                                                : "text-red-400"
                                        }`}
                                    >
                                        ${metrics.difference.toLocaleString()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            })}
        </div>
    </div>
) : (
    <div class="text-center text-[var(--color-ash)] py-8">
        No activity data available
    </div>
)}

<style>
    .chart-view {
        transition: all 0.3s ease;
        border-radius: 0.5rem;
    }
    
    .chart-view.chart-active {
        outline: 2px solid var(--color-cyan);
        outline-offset: 4px;
        box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
    }
    
    .chart-view:not(.chart-active) {
        opacity: 0.7;
    }
    
    .chart-button-active {
        background-color: var(--color-cyan) !important;
        color: var(--color-slate) !important;
    }
    
    [data-chart-type]:not(.chart-button-active) {
        background-color: var(--color-mist) !important; 
        color: var(--color-bone) !important;
    }
</style>

<script is:inline>
    // Chart type switching functionality
    function initChartTypeSwitcher() {
        const chartButtons = document.querySelectorAll('[data-chart-type]');
        const chartViews = document.querySelectorAll('.chart-view');
        
        function switchChart(type) {
            // Hide all charts and remove active class
            chartViews.forEach(view => {
                if (view instanceof HTMLElement) {
                    view.style.display = 'none';
                    view.classList.remove('chart-active');
                }
            });
            
            // Show selected chart and add active class
            const selectedChart = document.getElementById(`chart-${type}`);
            if (selectedChart) {
                selectedChart.style.display = 'block';
                selectedChart.classList.add('chart-active');
            }
            
            // Update button styles
            chartButtons.forEach(btn => {
                const btnType = btn.getAttribute('data-chart-type');
                if (btnType === type) {
                    btn.classList.add('chart-button-active');
                    btn.classList.remove('bg-[var(--color-mist)]', 'text-[var(--color-bone)]');
                    btn.classList.add('text-[var(--color-slate)]');
                } else {
                    btn.classList.remove('chart-button-active');
                    btn.classList.remove('bg-[var(--color-cyan)]', 'text-[var(--color-slate)]');
                    btn.classList.add('bg-[var(--color-mist)]', 'text-[var(--color-bone)]');
                }
            });
        }
        
        // Add click handlers
        chartButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.getAttribute('data-chart-type');
                if (type) {
                    switchChart(type);
                }
            });
        });
    }
    
    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChartTypeSwitcher);
    } else {
        initChartTypeSwitcher();
    }
    
    // Re-initialize when analyze section is updated
    const observer = new MutationObserver(() => {
        if (document.querySelector('[data-chart-type]')) {
            initChartTypeSwitcher();
        }
    });
    
    const analyzeSection = document.getElementById('analyze-section');
    if (analyzeSection) {
        observer.observe(analyzeSection, { childList: true, subtree: true });
    }
</script>
