---
import Table from "../components/Table.astro";
import BaseLayout from "../layouts/BaseLayout.astro";
import { getActivityByUser } from "../lib/services";
import { activityData as activityDataMock } from "../fixtures/activity_data";
import { convertTimestampToDate, volumeMetricsCalc } from "../lib/utils";
import type { Activity } from "../types/polymarket";
import Analyze from "../components/Analyze.astro";

// Serialize initial data for client-side use
const initialUser = import.meta.env.VITE_TEST_USER || '';
const activityData: Activity[] | null = import.meta.env.PROD
    ? (await getActivityByUser(initialUser)).data
    : activityDataMock;
const isActivityDataValid = activityData && activityData.length > 0;
const volumeMetrics = volumeMetricsCalc(activityData || []);

// Serialize activity data for client-side pagination
const serializedActivityData = JSON.stringify(activityData || []);


---

<BaseLayout title="Activity">
    <!-- User Input Section -->
    <div class="mb-6">
        <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-end">
            <div class="flex-1 w-full sm:w-auto mt-6">
                <label for="user-input" class="block text-sm font-medium text-[var(--color-cyan)] mb-2">
                    User Address
                </label>
                <input
                    type="text"
                    id="user-input"
                    value={initialUser}
                    placeholder="Enter user address (e.g., 0x...)"
                    class="w-full px-4 bg-[var(--color-slate)] border border-[var(--color-mist)] rounded-lg text-[var(--color-bone)] placeholder:text-[var(--color-ash)] focus:outline-none focus:ring-2 focus:ring-[var(--color-cyan)] focus:border-transparent"
                />
            </div>
            <div class="w-full sm:w-auto mt-6">
                <label for="limit-input" class="block text-sm font-medium text-[var(--color-cyan)] mb-2">
                    Max Records
                </label>
                <input
                    type="number"
                    id="limit-input"
                    value="1000"
                    min="1"
                    max="10000"
                    placeholder="1000"
                    class="w-full px-4 bg-[var(--color-slate)] border border-[var(--color-mist)] rounded-lg text-[var(--color-bone)] placeholder:text-[var(--color-ash)] focus:outline-none focus:ring-2 focus:ring-[var(--color-cyan)] focus:border-transparent"
                />
            </div>
            <button
                id="fetch-button"
                class="px-6 py-2 bg-[var(--color-cyan)] text-[var(--color-slate)] font-semibold rounded-lg hover:bg-[var(--color-cyan)]/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
            >
                Fetch Activity
            </button>
        </div>
        <div id="error-message" class="mt-2 text-sm text-[var(--color-coral)] hidden"></div>
        <div id="loading-indicator" class="mt-2 text-sm text-[var(--color-cyan)] hidden">
            <span id="loading-text">Loading...</span>
            <div id="loading-progress" class="mt-2 hidden">
                <div class="w-full bg-[var(--color-mist)] rounded-full h-2">
                    <div id="progress-bar" class="bg-[var(--color-cyan)] h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="progress-text" class="mt-1 text-xs text-[var(--color-ash)]"></div>
            </div>
        </div>
    </div>

    <div class="text-lg font-bold text-cyan-400 my-2">Summary</div>
    {/* Volume Summary Boxes */}
    <div id="summary-section">
        {isActivityDataValid && (
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                {/* BUY Volume */}
                <div class="bg-[var(--color-slate)] border border-[var(--color-mist)] rounded-lg p-6">
                    <div class="text-sm text-[var(--color-ash)] mb-2 uppercase tracking-wider">
                        BUY Volume
                    </div>
                    <div class="text-2xl font-bold text-[var(--color-bone)] mb-1" id="buy-count">
                        {volumeMetrics.buyCount}
                    </div>
                    <div class="text-lg text-[var(--color-coral)]" id="buy-total">
                        ${volumeMetrics.buyTotal.toLocaleString()}
                    </div>
                </div>

                {/* REDEEM Volume */}
                <div class="bg-[var(--color-slate)] border border-[var(--color-mist)] rounded-lg p-6">
                    <div class="text-sm text-[var(--color-ash)] mb-2 uppercase tracking-wider">
                        REDEEM Volume
                    </div>
                    <div class="text-2xl font-bold text-[var(--color-bone)] mb-1" id="redeem-count">
                        {volumeMetrics.redeemCount}
                    </div>
                    <div class="text-lg text-[var(--color-cyan)]" id="redeem-total">
                        ${volumeMetrics.redeemTotal.toLocaleString()}
                    </div>
                </div>

                {/* Difference */}
                <div class="bg-[var(--color-slate)] border border-[var(--color-mist)] rounded-lg p-6">
                    <div class="text-sm text-[var(--color-ash)] mb-2 uppercase tracking-wider">
                        Difference
                    </div>
                    <div class="text-2xl font-bold text-[var(--color-bone)] mb-1" id="difference-count">
                        {volumeMetrics.buyCount - volumeMetrics.redeemCount}
                        <span class="text-sm text-gray-500">
                            unsuccessful trades
                        </span>
                    </div>
                    <div
                        class={`text-lg ${
                            volumeMetrics.difference >= 0
                                ? "text-[var(--color-cyan)]"
                                : "text-[var(--color-coral)]"
                        }`}
                        id="difference-total"
                    >
                        ${volumeMetrics.difference.toLocaleString()}
                    </div>
                </div>
            </div>
        )}
    </div>

    <div class="text-lg font-bold text-cyan-400 my-2">Analyze</div>
    <div id="analyze-section">
        {isActivityDataValid && <Analyze activityData={activityData} />}
    </div>

    
    <!-- Serialized initial data for client-side -->
    <script id="initial-activity-data" type="application/json" set:html={serializedActivityData}></script>

    <!-- Table to show all activity data -->
    <div class="text-lg font-bold text-cyan-400 my-2">Activity</div>
    <div id="table-section">
        {isActivityDataValid && (
            <Table>
                <Fragment slot="header">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-[var(--color-cyan)] uppercase tracking-wider">
                            Time
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-[var(--color-cyan)] uppercase tracking-wider">
                            Title
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-[var(--color-cyan)] uppercase tracking-wider">
                            Type
                        </th>
                    </tr>
                </Fragment>
                <Fragment slot="body">
                    {isActivityDataValid &&
                        activityData.map((activity) => (
                            <tr class="hover:bg-[var(--color-charcoal)]/50 transition-colors">
                                <td class="px-6 py-4 text-sm text-[var(--color-bone)]">
                                    {convertTimestampToDate(activity.timestamp)}
                                </td>
                                <td class="px-6 py-4 text-sm text-[var(--color-bone)]">
                                    {activity.title}
                                </td>
                                <td class="px-6 py-4 text-sm text-[var(--color-bone)]">
                                    {activity.type}
                                </td>
                            </tr>
                        ))}
                </Fragment>
            </Table>
        )}
    </div>

    <script>
        // @ts-nocheck
        // Client-side utility functions
        function calculateMetrics(activityData) {
            if (!activityData || activityData.length === 0) {
                return {
                    buyCount: 0,
                    buyTotal: 0,
                    redeemCount: 0,
                    redeemTotal: 0,
                    difference: 0,
                };
            }

            const buyActivities = activityData.filter(
                (a) => a.side === "BUY" || a.type === "TRADE",
            );
            const redeemActivities = activityData.filter((a) => a.type === "REDEEM");

            const buyTotal = buyActivities.reduce(
                (sum, a) => sum + (a.usdcSize || 0),
                0,
            );
            const redeemTotal = redeemActivities.reduce(
                (sum, a) => sum + (a.usdcSize || 0),
                0,
            );

            return {
                buyCount: buyActivities.length,
                buyTotal: Number(buyTotal.toFixed(2)),
                redeemCount: redeemActivities.length,
                redeemTotal: Number(redeemTotal.toFixed(2)),
                difference: Number((redeemTotal - buyTotal).toFixed(2)),
            };
        }

        function formatTimestamp(timestamp: number) {
            return new Date(timestamp * 1000).toLocaleString(undefined, {
                year: "numeric",
                month: "numeric",
                day: "numeric",
                hour: "numeric",
                minute: "2-digit",
                hour12: true,
                timeZone: "UTC",
            });
        }

        async function fetchActivityData(user: string, maxRecords: number, onProgress?: (current: number, total: number) => void) {
            const apiBaseUrl = 'https://data-api.polymarket.com';
            const limit = 100;
            const MAX_RECORDS = maxRecords || 1000;
            let offset = 0;
            const allActivities: any[] = [];
            let pageCount = 0;
            let totalEstimated = 0;

            try {
                // First, fetch the first page to estimate total
                const firstPageUrl = new URL(`${apiBaseUrl}/activity`);
                firstPageUrl.searchParams.set('user', user);
                firstPageUrl.searchParams.set('limit', limit.toString());
                firstPageUrl.searchParams.set('offset', '0');

                const firstResponse = await fetch(firstPageUrl.toString(), {
                    headers: {
                        'Accept': 'application/json',
                    },
                });

                if (!firstResponse.ok) {
                    throw new Error(`API request failed with status ${firstResponse.status}`);
                }

                const firstPageData = await firstResponse.json();
                
                if (!firstPageData || firstPageData.length === 0) {
                    return [];
                }

                allActivities.push(...firstPageData);
                pageCount = 1;
                
                // If we got a full page, estimate there might be more (up to MAX_RECORDS)
                if (firstPageData.length === limit) {
                    totalEstimated = Math.min(limit * 2, MAX_RECORDS); // Start with estimate of 2 pages, but cap at MAX_RECORDS
                    if (onProgress) {
                        onProgress(allActivities.length, totalEstimated);
                    }
                } else {
                    // Got less than limit, we're done
                    return allActivities;
                }

                // Continue fetching remaining pages up to MAX_RECORDS
                while (allActivities.length < MAX_RECORDS) {
                    offset += limit;
                    
                    // Calculate how many records we still need
                    const remainingRecords = MAX_RECORDS - allActivities.length;
                    const currentLimit = Math.min(limit, remainingRecords);
                    
                    const apiUrl = new URL(`${apiBaseUrl}/activity`);
                    apiUrl.searchParams.set('user', user);
                    apiUrl.searchParams.set('limit', currentLimit.toString());
                    apiUrl.searchParams.set('offset', offset.toString());

                    const response = await fetch(apiUrl.toString(), {
                        headers: {
                            'Accept': 'application/json',
                        },
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const pageData = await response.json();

                    // If no data returned, we've reached the end
                    if (!pageData || pageData.length === 0) {
                        break;
                    }

                    // Add this page's data to the collection (only up to MAX_RECORDS)
                    const recordsToAdd = Math.min(pageData.length, remainingRecords);
                    allActivities.push(...pageData.slice(0, recordsToAdd));
                    pageCount++;

                    // Update progress
                    if (pageData.length === limit && allActivities.length < MAX_RECORDS) {
                        // Might be more pages, update estimate (but cap at MAX_RECORDS)
                        totalEstimated = Math.min(Math.max(totalEstimated, allActivities.length + limit), MAX_RECORDS);
                    } else {
                        // Got less than limit, this is the last page
                        totalEstimated = allActivities.length;
                    }

                    if (onProgress) {
                        onProgress(allActivities.length, totalEstimated);
                    }

                    // If we've reached the maximum or got less than the limit, we're done
                    if (allActivities.length >= MAX_RECORDS || pageData.length < limit) {
                        break;
                    }
                }

                // Final progress update
                if (onProgress) {
                    onProgress(allActivities.length, allActivities.length);
                }

                return allActivities;
            } catch (error) {
                console.error('Error fetching activity data:', error);
                throw error;
            }
        }

        function updateSummary(metrics, hasData) {
            const summarySection = document.getElementById('summary-section');
            if (!summarySection) return;

            if (!hasData) {
                summarySection.innerHTML = '';
                return;
            }

            summarySection.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-[var(--color-slate)] border border-[var(--color-mist)] rounded-lg p-6">
                        <div class="text-sm text-[var(--color-ash)] mb-2 uppercase tracking-wider">BUY Volume</div>
                        <div class="text-2xl font-bold text-[var(--color-bone)] mb-1">${metrics.buyCount}</div>
                        <div class="text-lg text-[var(--color-coral)]">$${metrics.buyTotal.toLocaleString()}</div>
                    </div>
                    <div class="bg-[var(--color-slate)] border border-[var(--color-mist)] rounded-lg p-6">
                        <div class="text-sm text-[var(--color-ash)] mb-2 uppercase tracking-wider">REDEEM Volume</div>
                        <div class="text-2xl font-bold text-[var(--color-bone)] mb-1">${metrics.redeemCount}</div>
                        <div class="text-lg text-[var(--color-cyan)]">$${metrics.redeemTotal.toLocaleString()}</div>
                    </div>
                    <div class="bg-[var(--color-slate)] border border-[var(--color-mist)] rounded-lg p-6">
                        <div class="text-sm text-[var(--color-ash)] mb-2 uppercase tracking-wider">Difference</div>
                        <div class="text-2xl font-bold text-[var(--color-bone)] mb-1">
                            ${metrics.buyCount - metrics.redeemCount}
                            <span class="text-sm text-gray-500"> unsuccessful trades</span>
                        </div>
                        <div class="text-lg ${metrics.difference >= 0 ? 'text-[var(--color-cyan)]' : 'text-[var(--color-coral)]'}">
                            $${metrics.difference.toLocaleString()}
                        </div>
                    </div>
                </div>
            `;
        }

        // Store full activity data for pagination
        let fullActivityData = [];
        let currentPage = 1;
        const recordsPerPage = 100;

        function updateTable(activityData, page = 1) {
            const tableSection = document.getElementById('table-section');
            if (!tableSection) return;

            // Store full data
            fullActivityData = activityData || [];
            currentPage = page;

            if (!fullActivityData || fullActivityData.length === 0) {
                tableSection.innerHTML = '<div class="text-center text-[var(--color-ash)] py-8">No activity data available</div>';
                return;
            }

            // Calculate pagination
            const totalPages = Math.ceil(fullActivityData.length / recordsPerPage);
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const currentPageData = fullActivityData.slice(startIndex, endIndex);

            // Generate pagination HTML
            const paginationHTML = generatePaginationHTML(currentPage, totalPages);

            const tableHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-[var(--color-mist)]">
                        <thead class="bg-[var(--color-slate)]">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-[var(--color-cyan)] uppercase tracking-wider">
                                    Time
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-[var(--color-cyan)] uppercase tracking-wider">
                                    Title
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-[var(--color-cyan)] uppercase tracking-wider">
                                    Type
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-[var(--color-slate)] divide-y divide-[var(--color-mist)]">
                            ${currentPageData.map((activity) => `
                                <tr class="hover:bg-[var(--color-charcoal)]/50 transition-colors">
                                    <td class="px-6 py-4 text-sm text-[var(--color-bone)]">
                                        ${formatTimestamp(activity.timestamp)}
                                    </td>
                                    <td class="px-6 py-4 text-sm text-[var(--color-bone)]">
                                        ${activity.title || ''}
                                    </td>
                                    <td class="px-6 py-4 text-sm text-[var(--color-bone)]">
                                        ${activity.type || ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ${paginationHTML}
            `;
            tableSection.innerHTML = tableHTML;

            // Attach event listeners to pagination buttons
            attachPaginationListeners();
        }

        function generatePaginationHTML(currentPage, totalPages) {
            // Always show pagination if there's data, even if only one page
            // This helps users understand the pagination system
            if (totalPages < 1) {
                return '';
            }

            const pageNumbers = [];
            const maxVisiblePages = 7;

            if (totalPages <= maxVisiblePages) {
                // Show all pages if total is less than max visible
                for (let i = 1; i <= totalPages; i++) {
                    pageNumbers.push(i);
                }
            } else {
                // Always show first page
                pageNumbers.push(1);

                if (currentPage <= 3) {
                    // Near the beginning
                    for (let i = 2; i <= 4; i++) {
                        pageNumbers.push(i);
                    }
                    pageNumbers.push('...');
                    pageNumbers.push(totalPages);
                } else if (currentPage >= totalPages - 2) {
                    // Near the end
                    pageNumbers.push('...');
                    for (let i = totalPages - 3; i <= totalPages; i++) {
                        pageNumbers.push(i);
                    }
                } else {
                    // In the middle
                    pageNumbers.push('...');
                    for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                        pageNumbers.push(i);
                    }
                    pageNumbers.push('...');
                    pageNumbers.push(totalPages);
                }
            }

            const prevDisabled = currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-[var(--color-cyan)]/20';
            const nextDisabled = currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-[var(--color-cyan)]/20';

            return `
                <div class="mt-6 flex items-center justify-between border-t border-[var(--color-mist)] bg-[var(--color-slate)] px-4 py-3 sm:px-6">
                    <div class="flex flex-1 justify-between sm:hidden">
                        <button
                            id="pagination-prev-mobile"
                            class="relative inline-flex items-center rounded-md border border-[var(--color-mist)] bg-[var(--color-slate)] px-4 py-2 text-sm font-medium text-[var(--color-bone)] ${prevDisabled}"
                            ${currentPage === 1 ? 'disabled' : ''}
                        >
                            Previous
                        </button>
                        <button
                            id="pagination-next-mobile"
                            class="relative ml-3 inline-flex items-center rounded-md border border-[var(--color-mist)] bg-[var(--color-slate)] px-4 py-2 text-sm font-medium text-[var(--color-bone)] ${nextDisabled}"
                            ${currentPage === totalPages ? 'disabled' : ''}
                        >
                            Next
                        </button>
                    </div>
                    <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-[var(--color-bone)]">
                                Showing <span class="font-medium">${((currentPage - 1) * recordsPerPage) + 1}</span> to <span class="font-medium">${Math.min(currentPage * recordsPerPage, fullActivityData.length)}</span> of <span class="font-medium">${fullActivityData.length}</span> results
                            </p>
                        </div>
                        <div>
                            <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                                <button
                                    id="pagination-prev"
                                    class="relative inline-flex items-center rounded-l-md px-2 py-2 text-[var(--color-bone)] ring-1 ring-inset ring-[var(--color-mist)] hover:bg-[var(--color-cyan)]/20 focus:z-20 focus:outline-offset-0 ${prevDisabled}"
                                    ${currentPage === 1 ? 'disabled' : ''}
                                >
                                    <span class="sr-only">Previous</span>
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                ${pageNumbers.map((page, index) => {
                                    if (page === '...') {
                                        return `
                                            <span class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-[var(--color-ash)] ring-1 ring-inset ring-[var(--color-mist)]">
                                                ...
                                            </span>
                                        `;
                                    }
                                    const isActive = page === currentPage;
                                    return `
                                        <button
                                            data-page="${page}"
                                            class="pagination-page relative inline-flex items-center px-4 py-2 text-sm font-semibold ${
                                                isActive
                                                    ? 'z-10 bg-[var(--color-cyan)] text-[var(--color-slate)] focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--color-cyan)]'
                                                    : 'text-[var(--color-bone)] ring-1 ring-inset ring-[var(--color-mist)] hover:bg-[var(--color-cyan)]/20 focus:z-20 focus:outline-offset-0'
                                            }"
                                        >
                                            ${page}
                                        </button>
                                    `;
                                }).join('')}
                                <button
                                    id="pagination-next"
                                    class="relative inline-flex items-center rounded-r-md px-2 py-2 text-[var(--color-bone)] ring-1 ring-inset ring-[var(--color-mist)] hover:bg-[var(--color-cyan)]/20 focus:z-20 focus:outline-offset-0 ${nextDisabled}"
                                    ${currentPage === totalPages ? 'disabled' : ''}
                                >
                                    <span class="sr-only">Next</span>
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            `;
        }

        function attachPaginationListeners() {
            // Previous button (desktop)
            const prevBtn = document.getElementById('pagination-prev');
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        updateTable(fullActivityData, currentPage - 1);
                        // Scroll to top of table
                        const tableSection = document.getElementById('table-section');
                        if (tableSection) {
                            tableSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                });
            }

            // Next button (desktop)
            const nextBtn = document.getElementById('pagination-next');
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(fullActivityData.length / recordsPerPage);
                    if (currentPage < totalPages) {
                        updateTable(fullActivityData, currentPage + 1);
                        // Scroll to top of table
                        const tableSection = document.getElementById('table-section');
                        if (tableSection) {
                            tableSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                });
            }

            // Previous button (mobile)
            const prevBtnMobile = document.getElementById('pagination-prev-mobile');
            if (prevBtnMobile) {
                prevBtnMobile.addEventListener('click', () => {
                    if (currentPage > 1) {
                        updateTable(fullActivityData, currentPage - 1);
                        const tableSection = document.getElementById('table-section');
                        if (tableSection) {
                            tableSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                });
            }

            // Next button (mobile)
            const nextBtnMobile = document.getElementById('pagination-next-mobile');
            if (nextBtnMobile) {
                nextBtnMobile.addEventListener('click', () => {
                    const totalPages = Math.ceil(fullActivityData.length / recordsPerPage);
                    if (currentPage < totalPages) {
                        updateTable(fullActivityData, currentPage + 1);
                        const tableSection = document.getElementById('table-section');
                        if (tableSection) {
                            tableSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                });
            }

            // Page number buttons
            const pageButtons = document.querySelectorAll('.pagination-page');
            pageButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = parseInt(btn.getAttribute('data-page') || '1');
                    if (page !== currentPage) {
                        updateTable(fullActivityData, page);
                        // Scroll to top of table
                        const tableSection = document.getElementById('table-section');
                        if (tableSection) {
                            tableSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                });
            });
        }

        function getBucketInfo(timestamp) {
            const date = new Date(timestamp * 1000);
            const hour = date.getUTCHours();
            
            let bucketDate = new Date(date);
            if (hour < 12) {
                bucketDate.setUTCDate(bucketDate.getUTCDate() - 1);
            }
            
            bucketDate.setUTCHours(0, 0, 0, 0);
            
            const day1 = new Date(bucketDate);
            const day2 = new Date(day1);
            day2.setUTCDate(day2.getUTCDate() + 1);
            
            const formatDate = (d) => {
                return d.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    timeZone: 'UTC'
                });
            };
            
            return {
                key: `${formatDate(day1)} - ${formatDate(day2)}`,
                startDate: day1
            };
        }

        function calculateBucketMetrics(activities) {
            const buyActivities = activities.filter(
                (a) => a.side === "BUY" || a.type === "TRADE"
            );
            const redeemActivities = activities.filter((a) => a.type === "REDEEM");
            
            const buyTotal = buyActivities.reduce(
                (sum, a) => sum + (a.usdcSize || 0),
                0
            );
            const redeemTotal = redeemActivities.reduce(
                (sum, a) => sum + (a.usdcSize || 0),
                0
            );
            
            return {
                buyCount: buyActivities.length,
                buyTotal: Number(buyTotal.toFixed(2)),
                redeemCount: redeemActivities.length,
                redeemTotal: Number(redeemTotal.toFixed(2)),
                difference: Number((redeemTotal - buyTotal).toFixed(2)),
            };
        }

        function updateAnalyze(activityData) {
            const analyzeSection = document.getElementById('analyze-section');
            if (!analyzeSection) return;

            if (!activityData || activityData.length === 0) {
                analyzeSection.innerHTML = '<div class="text-center text-[var(--color-ash)] py-8">No activity data available</div>';
                return;
            }

            // Group activities into buckets
            const buckets = new Map();
            activityData.forEach((activity) => {
                const bucketInfo = getBucketInfo(activity.timestamp);
                if (!buckets.has(bucketInfo.key)) {
                    buckets.set(bucketInfo.key, {
                        key: bucketInfo.key,
                        startDate: bucketInfo.startDate,
                        activities: []
                    });
                }
                buckets.get(bucketInfo.key).activities.push(activity);
            });

            // Convert to array and sort by date (most recent first)
            const bucketEntries = Array.from(buckets.values()).sort((a, b) => {
                return b.startDate.getTime() - a.startDate.getTime();
            });

            // Prepare chart data (sorted chronologically, oldest first for chart)
            const chartData = bucketEntries
                .map((bucket) => {
                    const metrics = calculateBucketMetrics(bucket.activities);
                    return {
                        name: bucket.key,
                        difference: metrics.difference,
                    };
                })
                .reverse(); // Reverse to show oldest to newest

            // Update chart data via custom event
            window.dispatchEvent(new CustomEvent('chart-data-update', { detail: chartData }));

            // Generate HTML for bucket cards
            const bucketsHTML = bucketEntries.map((bucket) => {
                const metrics = calculateBucketMetrics(bucket.activities);
                return `
                    <div class="bg-[var(--color-slate)] border border-[var(--color-mist)] rounded-lg p-4">
                        <div class="text-sm font-semibold text-[var(--color-cyan)] mb-2 border-b border-[var(--color-mist)]">
                            ${bucket.key}
                        </div>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-[var(--color-ash)] uppercase tracking-wider">BUY</span>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-[var(--color-bone)]">${metrics.buyCount} trades</div>
                                    <div class="text-sm text-[var(--color-coral)]">$${metrics.buyTotal.toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-[var(--color-ash)] uppercase tracking-wider">REDEEM</span>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-[var(--color-bone)]">${metrics.redeemCount} trades</div>
                                    <div class="text-sm text-[var(--color-cyan)]">$${metrics.redeemTotal.toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-[var(--color-mist)]">
                                <span class="text-sm text-[var(--color-ash)] uppercase tracking-wider">Difference</span>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-[var(--color-bone)]">${metrics.buyCount - metrics.redeemCount}</div>
                                    <div class="text-sm font-semibold ${metrics.difference >= 0 ? 'text-green-400' : 'text-red-400'}">$${metrics.difference.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update only the cards grid, preserve chart container
            const cardsContainer = analyzeSection.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3');
            if (cardsContainer) {
                cardsContainer.innerHTML = bucketsHTML;
            } else {
                // If cards container doesn't exist, try to find or create the structure
                let spaceY6 = analyzeSection.querySelector('.space-y-6');
                if (!spaceY6) {
                    // Create the space-y-6 container if it doesn't exist
                    spaceY6 = document.createElement('div');
                    spaceY6.className = 'space-y-6';
                    analyzeSection.innerHTML = '';
                    analyzeSection.appendChild(spaceY6);
                }
                
                // Ensure chart container exists
                let chartContainer = spaceY6.querySelector('#bar-chart-container');
                if (!chartContainer) {
                    chartContainer = document.createElement('div');
                    chartContainer.id = 'bar-chart-container';
                    spaceY6.appendChild(chartContainer);
                }
                
                // Create or update cards container
                let cardsDiv = spaceY6.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3');
                if (!cardsDiv) {
                    cardsDiv = document.createElement('div');
                    cardsDiv.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6';
                    spaceY6.appendChild(cardsDiv);
                }
                cardsDiv.innerHTML = bucketsHTML;
            }
        }

        // Event handlers
        const userInput = document.getElementById('user-input') as HTMLInputElement;
        const limitInput = document.getElementById('limit-input') as HTMLInputElement;
        const fetchButton = document.getElementById('fetch-button') as HTMLButtonElement;
        const errorMessage = document.getElementById('error-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');
        const loadingProgress = document.getElementById('loading-progress');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        fetchButton?.addEventListener('click', async () => {
            // polymarket adds timestamp to the user address when copied from the website
            const user = userInput?.value.trim().split('-')[0];
            
            if (!user) {
                if (errorMessage) {
                    errorMessage.textContent = 'Please enter a user address';
                    errorMessage.classList.remove('hidden');
                }
                return;
            }

            // Get limit from input, default to 1000 if invalid
            const maxRecords = parseInt(limitInput?.value || '1000', 10);
            const validMaxRecords = isNaN(maxRecords) || maxRecords < 1 ? 1000 : Math.min(maxRecords, 10000);

            // Show loading state
            fetchButton.disabled = true;
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');
            if (loadingText) loadingText.textContent = 'Loading...';
            if (loadingProgress) loadingProgress.classList.add('hidden');
            if (errorMessage) errorMessage.classList.add('hidden');

            try {
                const activityData = await fetchActivityData(user, validMaxRecords, (current, total) => {
                    // Update progress indicator
                    if (loadingText) {
                        loadingText.textContent = `Loading... (${current.toLocaleString()} records)`;
                    }
                    if (loadingProgress && progressBar && progressText) {
                        loadingProgress.classList.remove('hidden');
                        const percentage = total > 0 ? Math.min(100, Math.round((current / total) * 100)) : 0;
                        progressBar.style.width = `${percentage}%`;
                        progressText.textContent = `${current.toLocaleString()} / ${total > current ? `~${total.toLocaleString()}` : current.toLocaleString()} records`;
                    }
                });
                
                if (!activityData || activityData.length === 0) {
                    throw new Error('No activity data found for this user');
                }

                // Final loading message
                if (loadingText) {
                    loadingText.textContent = `Processing ${activityData.length.toLocaleString()} records...`;
                }

                const metrics = calculateMetrics(activityData || []);
                updateSummary(metrics, activityData && activityData.length > 0);
                updateTable(activityData);
                updateAnalyze(activityData);

                // Hide loading, show success
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                if (loadingProgress) loadingProgress.classList.add('hidden');
            } catch (error) {
                console.error('Error fetching activity:', error);
                if (errorMessage) {
                    errorMessage.textContent = error instanceof Error ? error.message : 'Failed to fetch activity data';
                    errorMessage.classList.remove('hidden');
                }
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                if (loadingProgress) loadingProgress.classList.add('hidden');
            } finally {
                fetchButton.disabled = false;
            }
        });

        // Allow Enter key to trigger fetch
        userInput?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                fetchButton?.click();
            }
        });

        // Initialize table with pagination on page load if initial data exists
        function initializeTableWithPagination() {
            const initialDataScript = document.getElementById('initial-activity-data');
            if (initialDataScript) {
                try {
                    const initialData = JSON.parse(initialDataScript.textContent || '[]');
                    if (initialData && Array.isArray(initialData) && initialData.length > 0) {
                        updateTable(initialData, 1);
                    }
                } catch (e) {
                    console.error('Error parsing initial activity data:', e);
                }
            }
        }

        // Run initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTableWithPagination);
        } else {
            // DOM is already ready
            initializeTableWithPagination();
        }
    </script>
</BaseLayout>
